rules_version = '2';
// SIMPLIFIED RULES - Allow all authenticated users to read/write their data
// Updated: 2024-12-18 16:00 IST
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Users - read/write own data
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Projects - owner by email
    match /projects/{projectId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null;
      
      // Subcollections
      match /scripts/{scriptId} {
        allow read, write: if request.auth != null;
      }
      
      match /jobs/{jobId} {
        allow read, write: if request.auth != null;
      }
      
      // Project datasets subcollection
      match /datasets/{datasetId} {
        allow read, write: if request.auth != null;
      }
      
      // Project messages subcollection
      match /messages/{messageId} {
        allow read, write: if request.auth != null;
      }
      
      // Project deployments subcollection
      match /deployments/{deploymentId} {
        allow read, write: if request.auth != null;
      }
    }
    
    // Top-level Datasets
    match /datasets/{datasetId} {
      allow read, write: if request.auth != null;
    }
    
    // User Datasets
    match /user_datasets/{datasetId} {
      allow read, write: if request.auth != null;
    }
    
    // Chat Sessions
    match /chat_sessions/{sessionId} {
      allow read, write: if request.auth != null;
      
      match /messages/{messageId} {
        allow read, write: if request.auth != null;
      }
    }
    
    // Charts
    match /charts/{chartId} {
      allow read, write: if request.auth != null;
    }
    
    // Models
    match /models/{modelId} {
      allow read, write: if request.auth != null;
      
      match /versions/{versionId} {
        allow read, write: if request.auth != null;
      }
    }
    
    // Suggestions
    match /suggestions/{suggestionId} {
      allow read, write: if request.auth != null;
    }
    
    // Jobs (global)
    match /jobs/{jobId} {
      allow read, write: if request.auth != null;
    }
    
    // Collab links
    match /collab_links/{linkId} {
      allow read, write: if request.auth != null;
    }
    
    // MCP docs
    match /mcp_docs/{docId} {
      allow read, write: if request.auth != null;
    }
    
    // API keys
    match /api_keys/{keyId} {
      allow read, write: if request.auth != null;
    }
    
    // Deploy logs
    match /deploy_logs/{modelId} {
      allow read: if request.auth != null;
      allow write: if false;
      
      match /requests/{logId} {
        allow read: if request.auth != null;
        allow write: if false;
      }
    }
    
    // Telemetry
    match /telemetry/{document=**} {
      allow read, write: if request.auth != null;
    }
    
    // System
    match /system/{document=**} {
      allow read, write: if request.auth != null;
    }
    
    // Health check
    match /_healthcheck/{docId} {
      allow read: if false;
      allow write: if true;
    }
    
    // Rate limits
    match /rate_limits/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if false;
    }
  }
}
